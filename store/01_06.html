<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>장바구니 내역</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="css/navbar.css?v=val_251015_001">
    <link rel="stylesheet" href="test/test.css?v=val_251015_001">
    <link rel="stylesheet" href="css/admin_store.css?v=val_251015_001">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
    <style>
        .kpi-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-bottom:12px; }
        @media (max-width:900px) { .kpi-grid { grid-template-columns:repeat(2,1fr); } }
        @media (max-width:560px) { .kpi-grid { grid-template-columns:1fr; } }
        .kpi { display:flex; justify-content:space-between; align-items:flex-end; padding:12px; border:1px dashed #e2e8f0; border-radius:12px; background:#fbfdff; }
        .kpi .v { font-size:20px; font-weight:900; }
        .kpi .l { color:var(--cb-sub); font-size:13px; }
        .filters { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:12px; }
        .filters .grow { flex:1; }
        .filters .seg { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
        .tbl { width:100%; border-collapse:separate; border-spacing:0; }
        .tbl th, .tbl td { border-bottom:1px solid var(--cb-line); padding:10px 8px; text-align:left; vertical-align:top; }
        .tbl th { background:#f9fbfe; color:#3a4a62; font-weight:700; }
        .tbl tr:last-child td { border-bottom:none; }
        .badge.ok { background:#e9f7ef; color:#1e7e34; border:1px solid #d6f0de; }
        .badge.warn { background:#fff6d8; color:#8a6d00; border:1px solid #ffe9a8; }
        .thumb { width:56px; height:56px; border-radius:8px; overflow:hidden; border:1px solid var(--cb-line); background:#fafafa; }
        .thumb img { width:100%; height:100%; object-fit:cover; display:block; }
        .list { display:none; }
        @media (max-width:860px) {
            .table-wrap { display:none; }
            .list { display:grid; gap:10px; }
            .row-card { border:1px solid var(--cb-line); border-radius:14px; padding:12px; display:grid; grid-template-columns:56px 1fr auto; gap:10px; align-items:center; }
            .row-card .meta { font-size:12px; color:var(--cb-sub); }
            .row-card .r { justify-self:end; text-align:right; }
            .pill { display:inline-flex; gap:6px; align-items:center; padding:6px 10px; border:1px solid var(--cb-line); border-radius:999px; font-size:12px; }
        }
        .toolbar { display:flex; gap:8px; justify-content:space-between; align-items:center; margin-top:12px; flex-wrap:wrap; }
        .pager { display:flex; gap:8px; align-items:center; }
    </style>
</head>
<body>
    <aside class="cb-sidemenu"><!--개발시 해당 메뉴는 기존 메뉴를 사용하세요 {% include 'admin/navbar.html' %} -->
        <div class="cb-sidemenu-inner cb-menu-style">
            <div class="cb-menu-admin-logo" style="text-align:center;margin-bottom:12px;"><img src="test/testai.png" alt="사이트 로고" style="max-width:150px;object-fit:contain;"></div>
            <div class="cb-menu-admin-name">테스트 관리자님<br></div>
            <a><span class="cb-menu-icon"><i class="fa-solid fa-arrow-right-from-bracket"></i></span>로그아웃</a>
            <div class="cb-menu-toggle-all" style="display:flex;gap:15px;justify-content:flex-end;padding:12px;">
                <a type="button" onclick="expandAllMenus()" class="toggle_all" id="expandAllBtn_p">＋</a>
                <a type="button" onclick="collapseAllMenus()" class="toggle_all" id="collapseAllBtn_p">－</a>
            </div>
            <div class="cb-menu-group" data-key="menu_general">
                <div class="cb-menu-group-title" onclick="toggleMenuGroup(this)">스토어 관리</div>
                <div class="cb-menu-group-body">
                    <a href="01_01.html" class="cb-sidemenu-link"><span class="cb-menu-icon"><i class="fa-solid fa-store"></i></span>스토어 설정</a>
                    <a href="01_02.html" class="cb-sidemenu-link"><span class="cb-menu-icon"><i class="fa-solid fa-chart-line"></i></span>매출 통계</a>
                    <a href="01_03.html" class="cb-sidemenu-link"><span class="cb-menu-icon"><i class="fa-solid fa-tags"></i></span>카테고리 관리</a>
                    <a href="01_04.html" class="cb-sidemenu-link"><span class="cb-menu-icon"><i class="fa-solid fa-boxes-stacked"></i></span>상품 관리</a>
                    <a href="01_05.html" class="cb-sidemenu-link"><span class="cb-menu-icon"><i class="fa-solid fa-file-invoice-dollar"></i></span>주문/결제 관리</a>
                    <a href="01_06.html" class="cb-sidemenu-link"><span class="cb-menu-icon"><i class="fa-solid fa-basket-shopping"></i></span>장바구니 내역</a>
                    <a href="01_07.html" class="cb-sidemenu-link"><span class="cb-menu-icon"><i class="fa-solid fa-ticket"></i></span>쿠폰 발행</a>
                </div>
            </div>
            <a>&nbsp;</a>
        </div>
    </aside>
    <div class="wrap">
        <div class="title">장바구니 내역
            <select id="siteIdSelect" name="site_id" onchange="location.href='?site_id='+this.value" style="width:200px;">
                <option value="">전체 사이트</option>
                <option value="acb_allteaching_child">올티칭 유치원</option>
                <option value="acb_academy_allteaching">올티칭 수학학원</option>
                <option value="acb_songchon">세무법인 송촌</option>
                <option value="acb_study_yi">올티칭스터디카페 물푸레점</option>
                <option value="acb_mokdongmath">목동최상위수학학원</option>
                <option value="acb_lms1">헬프lms</option>
                <option value="acb_study_gm">스터디카페 광명점</option>
                <option value="acb_study">구했어</option>
                <option value="acb_studycafe">스터디카페</option>
                <option value="acb_at_test">챗봇 테스트</option>
                <option value="acb_culture">올티칭 컬쳐</option>
                <option value="acb_cam">올티칭 캠퍼스</option>
                <option value="acb_biz">올티칭 캠퍼스</option>
                <option value="acb_ecce">올티칭 학점은행</option>
                <option value="acb_ai">올티칭 AI</option>
                <option value="acb_scce">올티칭 서사평</option>
            </select>
        </div>
        <div class="sub">사이트별·회원별 장바구니 현황을 조회합니다. 최근 담긴 순/금액순 정렬, CSV 내보내기 제공.</div>
        <div class="kpi-grid">
            <div class="kpi"><div class="l">총 장바구니 수</div><div class="v" id="kpiCarts">-</div></div>
            <div class="kpi"><div class="l">총 상품 수(개)</div><div class="v" id="kpiItems">-</div></div>
            <div class="kpi"><div class="l">예상 매출 합계</div><div class="v" id="kpiAmount">-</div></div>
            <div class="kpi"><div class="l">최근 추가(24h)</div><div class="v" id="kpiRecent">-</div></div>
        </div>
        <div class="card filters">
            <div class="seg"><span class="muted"><i class="fa-regular fa-calendar"></i> 기간</span><input type="date" id="fromDate" class="box"><span>~</span><input type="date" id="toDate" class="box"></div>
            <div class="seg">
                <select id="selSite" class="box">
                    <option value="">사이트 전체</option>
                    <option value="acb_ecce">올티칭 학점은행</option>
                    <option value="acb_scce">올티칭 서사평</option>
                    <option value="acb_ai">올티칭 AI</option>
                </select>
                <select id="selSort" class="box">
                    <option value="recent">최근 담긴 순</option>
                    <option value="amount">금액 높은 순</option>
                    <option value="qty">수량 많은 순</option>
                </select>
            </div>
            <div class="grow"></div>
            <div class="seg"><input id="q" class="box" placeholder="회원ID/이름/상품명/SKU"><button class="btn small" id="btnSearch"><i class="fa-solid fa-magnifying-glass"></i> 검색</button><button class="btn small" id="btnCsv"><i class="fa-solid fa-file-arrow-down"></i> CSV</button></div>
        </div>
        <div class="table-wrap card">
            <table class="tbl" id="tbl">
                <thead>
                    <tr>
                        <th style="width:140px">사이트</th>
                        <th>회원</th>
                        <th>상품</th>
                        <th style="width:90px">수량</th>
                        <th style="width:120px">단가</th>
                        <th style="width:120px">소계</th>
                        <th style="width:160px">담긴 시각</th>
                        <th style="width:90px">기기</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <div class="toolbar">
                <div class="muted" id="resultInfo">0건</div>
                <div class="pager">
                    <button class="btn small" id="prev">이전</button>
                    <span class="muted" id="pageInfo">1 / 1</span>
                    <button class="btn small" id="next">다음</button>
                </div>
            </div>
        </div>
        <div class="list" id="list"></div>
    </div>
    <script>
        const fmtKRW = n => n > 0 ? (n.toLocaleString('ko-KR') + '원') : '-';

        const cartsData = [
            {site:'acb_ecce',siteName:'올티칭 학점은행',userId:'kim01',userName:'김*민',item:{title:'사회복지학 전필 패키지',sku:'SW-CORE-8',price:390000,sale:290000,qty:1,img:'https://picsum.photos/seed/b1/200/200'},device:'mobile',added:'2025-10-12 13:40'},
            {site:'acb_scce',siteName:'올티칭 서사평',userId:'lee22',userName:'이*현',item:{title:'평가인정 과제 컨설팅',sku:'EV-101',price:120000,sale:0,qty:2,img:'https://picsum.photos/seed/b2/200/200'},device:'pc',added:'2025-10-12 09:12'},
            {site:'acb_ai',siteName:'올티칭 AI',userId:'park77',userName:'박*준',item:{title:'AI 업무자동화 강의',sku:'AI-AUTO',price:99000,sale:89000,qty:1,img:'https://picsum.photos/seed/b3/200/200'},device:'mobile',added:'2025-10-11 22:01'},
            {site:'acb_ecce',siteName:'올티칭 학점은행',userId:'sunny',userName:'손*희',item:{title:'보육교사 패키지',sku:'ED-CHILD',price:450000,sale:410000,qty:1,img:'https://picsum.photos/seed/b4/200/200'},device:'pc',added:'2025-10-10 18:25'},
            {site:'acb_scce',siteName:'올티칭 서사평',userId:'choi9',userName:'최*아',item:{title:'현장실습 매칭',sku:'FIELD-01',price:150000,sale:0,qty:1,img:'https://picsum.photos/seed/b5/200/200'},device:'mobile',added:'2025-10-09 11:02'},
            {site:'acb_ai',siteName:'올티칭 AI',userId:'joon',userName:'문*준',item:{title:'프롬프트 엔지니어링',sku:'PE-101',price:129000,sale:0,qty:3,img:'https://picsum.photos/seed/b6/200/200'},device:'pc',added:'2025-10-08 15:33'}
        ];

        const elTBody = document.querySelector('#tbl tbody');
        const elResult = document.getElementById('resultInfo');
        const elPageInfo = document.getElementById('pageInfo');
        const elList = document.getElementById('list');
        const PAGE = 8;
        let page = 1;

        const val = (it) => (it.item.sale && it.item.sale < it.item.price ? it.item.sale : it.item.price) * it.item.qty;

        function applyFilters() {
            const site = document.getElementById('selSite').value || document.getElementById('siteIdSelect').value;
            const q = (document.getElementById('q').value || '').toLowerCase().trim();
            const fd = document.getElementById('fromDate').value;
            const td = document.getElementById('toDate').value;

            let list = cartsData.filter(r => {
                if (site && r.site !== site) return false;
                if (fd && new Date(r.added.replace(' ', 'T')) < new Date(fd + 'T00:00:00')) return false;
                if (td && new Date(r.added.replace(' ', 'T')) > new Date(td + 'T23:59:59')) return false;
                if (q) {
                    const hay = [r.userId, r.userName, r.item.title, r.item.sku, r.siteName].join(' ').toLowerCase();
                    if (!hay.includes(q)) return false;
                }
                return true;
            });

            const sort = document.getElementById('selSort').value;
            if (sort === 'recent') list.sort((a, b) => new Date(b.added) - new Date(a.added));
            if (sort === 'amount') list.sort((a, b) => val(b) - val(a));
            if (sort === 'qty') list.sort((a, b) => b.item.qty - a.item.qty);

            return list;
        }

        function render() {
            const list = applyFilters();

            const cartCnt = new Set(list.map(x => x.userId + '@' + x.site)).size;
            const itemsCnt = list.reduce((s, r) => s + r.item.qty, 0);
            const amount = list.reduce((s, r) => s + val(r), 0);
            const recent = list.filter(r => (Date.now() - new Date(r.added.replace(' ', 'T')).getTime()) / (3600e3) <= 24).length;
            document.getElementById('kpiCarts').textContent = cartCnt.toLocaleString('ko-KR');
            document.getElementById('kpiItems').textContent = itemsCnt.toLocaleString('ko-KR');
            document.getElementById('kpiAmount').textContent = fmtKRW(amount);
            document.getElementById('kpiRecent').textContent = recent.toLocaleString('ko-KR');

            const totalPages = Math.max(1, Math.ceil(list.length / PAGE));
            page = Math.min(page, totalPages);
            const start = (page - 1) * PAGE;
            const slice = list.slice(start, start + PAGE);

            elTBody.innerHTML = '';
            slice.forEach(r => {
                const base = r.item.sale && r.item.sale < r.item.price ? r.item.sale : r.item.price;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><span class="badge">${r.siteName}</span></td>
                    <td><div><b>${r.userId}</b> <span class="muted">(${r.userName})</span></div></td>
                    <td>
                        <div style="display:flex;gap:10px;align-items:center">
                            <div class="thumb"><img src="${r.item.img}" alt=""></div>
                            <div>
                                <div style="font-weight:800">${r.item.title}</div>
                                <div class="muted">SKU: ${r.item.sku || '-'}</div>
                            </div>
                        </div>
                    </td>
                    <td>${r.item.qty}</td>
                    <td>${fmtKRW(base)}</td>
                    <td>${fmtKRW(base * r.item.qty)}</td>
                    <td><span class="muted">${r.added}</span></td>
                    <td><span class="badge ${r.device === 'mobile' ? 'ok' : 'warn'}">${r.device}</span></td>
                `;
                elTBody.appendChild(tr);
            });

            elList.innerHTML = '';
            slice.forEach(r => {
                const base = r.item.sale && r.item.sale < r.item.price ? r.item.sale : r.item.price;
                const card = document.createElement('div');
                card.className = 'row-card';
                card.innerHTML = `
                    <div class="thumb"><img src="${r.item.img}" alt=""></div>
                    <div>
                        <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center">
                            <span class="badge">${r.siteName}</span>
                            <span class="pill"><i class="fa-regular fa-user"></i>${r.userId}<span class="muted">(${r.userName})</span></span>
                        </div>
                        <div style="font-weight:800;margin-top:6px">${r.item.title}</div>
                        <div class="meta">SKU: ${r.item.sku || '-'} · 수량 ${r.item.qty} · ${r.added}</div>
                    </div>
                    <div class="r">
                        <div>${fmtKRW(base)}</div>
                        <div class="muted">소계</div>
                        <div style="font-weight:900">${fmtKRW(base * r.item.qty)}</div>
                        <div style="margin-top:6px"><span class="badge ${r.device === 'mobile' ? 'ok' : 'warn'}">${r.device}</span></div>
                    </div>
                `;
                elList.appendChild(card);
            });

            elResult.textContent = `총 ${list.length.toLocaleString('ko-KR')}건`;
            elPageInfo.textContent = `${page} / ${totalPages}`;
            document.getElementById('prev').disabled = page <= 1;
            document.getElementById('next').disabled = page >= totalPages;
        }

        document.getElementById('btnSearch').onclick = () => { page = 1; render(); };
        document.getElementById('selSite').onchange = () => { page = 1; render(); };
        document.getElementById('siteIdSelect').onchange = () => { page = 1; render(); };
        document.getElementById('selSort').onchange = () => { page = 1; render(); };
        document.getElementById('fromDate').onchange = () => { page = 1; render(); };
        document.getElementById('toDate').onchange = () => { page = 1; render(); };
        document.getElementById('prev').onclick = () => { if (page > 1) { page--; render(); } };
        document.getElementById('next').onclick = () => { page++; render(); };

        document.getElementById('btnCsv').onclick = () => {
            const list = applyFilters();
            const rows = [['사이트','회원ID','회원명','상품명','SKU','수량','단가','소계','담긴 시각','기기']];
            list.forEach(r => {
                const base = r.item.sale && r.item.sale < r.item.price ? r.item.sale : r.item.price;
                rows.push([r.siteName, r.userId, r.userName, r.item.title, r.item.sku, r.item.qty, base, base * r.item.qty, r.added, r.device]);
            });
            const csv = rows.map(r => r.join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'carts_admin.csv';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        };

        (function initDates() {
            const now = new Date();
            const to = now.toISOString().slice(0, 10);
            const d = new Date(now);
            d.setDate(d.getDate() - 13);
            const from = d.toISOString().slice(0, 10);
            document.getElementById('fromDate').value = from;
            document.getElementById('toDate').value = to;
        })();

        render();

        function toggleMenuGroup(el) {
            const group = el.closest('.cb-menu-group');
            const key = group.dataset.key;
            const isCollapsed = group.classList.toggle('collapsed');
            const states = JSON.parse(localStorage.getItem('cb_menu_states') || '{}');
            states[key] = !isCollapsed;
            localStorage.setItem('cb_menu_states', JSON.stringify(states));
        }
        function expandAllMenus() {
            const states = {};
            document.querySelectorAll('.cb-menu-group[data-key]').forEach(group => {
                group.classList.remove('collapsed');
                states[group.getAttribute('data-key')] = true;
            });
            localStorage.setItem('cb_menu_states', JSON.stringify(states));
        }
        function collapseAllMenus() {
            const states = {};
            document.querySelectorAll('.cb-menu-group[data-key]').forEach(group => {
                group.classList.add('collapsed');
                states[group.getAttribute('data-key')] = false;
            });
            localStorage.setItem('cb_menu_states', JSON.stringify(states));
        }
    </script>
</body>
</html>
