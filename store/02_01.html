<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>쇼핑</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="css/navbar.css?v=val_251015_001">
    <link rel="stylesheet" href="test/test.css?v=val_251015_001">
    <link rel="stylesheet" href="css/member_store.css?v=val_251015_001">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
    <style>
        .grid-head{display:flex;align-items:center;justify-content:space-between;margin:6px 2px 10px;flex-wrap:wrap;gap:8px}
        .prod-grid{display:grid;gap:12px;grid-template-columns:repeat(4,1fr)}
        @media (max-width:960px){.prod-grid{grid-template-columns:repeat(2,1fr)}}
        @media (max-width:720px){.prod-grid{grid-template-columns:repeat(1,1fr)}}
        @media (max-width:420px){.prod-grid{grid-template-columns:1fr}}
        .product{background:#fff;border:1px solid var(--cb-line);border-radius:14px;overflow:hidden;box-shadow:var(--cb-shadow);display:flex;flex-direction:column}
        .thumb-wrap{position:relative;aspect-ratio:1/1;background:#fafafa;overflow:hidden}
        .thumb-wrap img{width:100%;height:100%;object-fit:cover}
        .badges{position:absolute;top:8px;left:8px;display:flex;gap:6px;flex-wrap:wrap}
        .badge.soldout{background:#fff6d8;color:#8a6d00}
        .badge.new{background:#e9f7ef;color:#1e7e34}
        .badge.sale{background:#ffecec;color:#b02a37}
        .p-body{padding:12px;display:flex;flex-direction:column;gap:8px;flex:1}
        .p-title{font-weight:800;font-size:15px;line-height:1.35;min-height:2.6em;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
        .p-cat{color:var(--cb-sub);font-size:12px}
        .p-price{display:flex;align-items:baseline;gap:8px}
        .p-price .sale{color:#b02a37;font-weight:800}
        .p-price .origin{color:#9aa6b2;text-decoration:line-through;font-size:13px}
        .p-actions{display:flex;gap:8px;margin-top:auto}
    </style>
</head>
<body>
    <aside class="cb-sidemenu"><!--개발시 해당 메뉴는 기존 메뉴를 사용하세요 {% include 'admin/navbar.html' %} -->
        <div class="cb-sidemenu-inner cb-menu-style">
            <div class="cb-menu-admin-logo" style="text-align:center; margin-bottom:12px;"><img src="test/testai.png" alt="사이트 로고" style="max-width:150px; object-fit:contain;"></div>
            <div class="cb-menu-admin-name">테스트 유저님<br></div>
            <a><span class="cb-menu-icon"><i class="fa-solid fa-arrow-right-from-bracket"></i></span>로그아웃</a>
            <div class="cb-menu-toggle-all" style="display:flex;gap:15px;justify-content:flex-end;padding:12px;">
                <a type="button" onclick="expandAllMenus()" class="toggle_all" id="expandAllBtn_p">＋</a>
                <a type="button" onclick="collapseAllMenus()" class="toggle_all" id="collapseAllBtn_p">－</a>
            </div>
            <div class="cb-menu-group" data-key="menu_general">
                <div class="cb-menu-group-title" onclick="toggleMenuGroup(this)">스토어</div>
                <div class="cb-menu-group-body">
                    <a href="02_01.html" class="cb-sidemenu-link"><span class="cb-menu-icon"><i class="fa-solid fa-cart-shopping"></i></span>쇼핑</a>
                    <a href="02_02.html" class="cb-sidemenu-link"><span class="cb-menu-icon"><i class="fa-solid fa-basket-shopping"></i></span>장바구니</a>
                    <a href="02_03.html" class="cb-sidemenu-link"><span class="cb-menu-icon"><i class="fa-solid fa-file-invoice-dollar"></i></span>주문/결제 내역</a>
                    <a href="02_04.html" class="cb-sidemenu-link"><span class="cb-menu-icon"><i class="fa-solid fa-ticket"></i></span>쿠폰</a>
                </div>
            </div>
            <a>&nbsp;</a>
        </div>
    </aside>
    <div class="wrap">
        <div class="title">쇼핑</div>
        <div class="sub">원하는 상품을 검색하거나 카테고리/정렬을 변경해 보세요.</div>
        <div class="topbar">
            <div class="filter card" style="padding:10px 12px;">
                <input class="box" id="q" placeholder="상품명/키워드 검색" />
                <select id="fCategory" title="카테고리"><option value="">카테고리 전체</option></select>
                <select id="fSort" title="정렬"><option value="best">인기순</option><option value="latest">신상품순</option><option value="low">가격 낮은순</option><option value="high">가격 높은순</option><option value="sale">할인율 높은순</option></select>
                <button class="btn small" id="btnSearch">검색</button>
                <button class="btn small ghost" id="btnReset">초기화</button>
            </div>
            <div class="spacer"></div>
            <div class="hint">가격은 부가세 포함.</div>
        </div>
        <div class="card">
            <div class="grid-head">
                <div class="range-info" id="rangeInfo">총 0개</div>
                <div class="page-size">
                    <span class="hint">페이지당</span>
                    <select id="selPageSize" class="box" style="width:auto; padding:8px 10px;"><option value="12" selected>12개</option><option value="24">24개</option><option value="36">36개</option></select>
                </div>
            </div>
            <div class="prod-grid" id="grid"></div>
            <div class="pager-wrap" aria-label="페이지 이동">
                <div></div>
                <div class="pager" id="pager"></div>
                <div></div>
            </div>
        </div>
    </div>
    <script>
        const categories = [
            { id: 1, name: "전자" },
            { id: 2, name: "도서" },
            { id: 3, name: "패션" },
            { id: 4, name: "리빙" }
        ];
        const now = Date.now();
        const daysAgo = d => new Date(now - d * 24 * 60 * 60 * 1000).toISOString().slice(0, 10);

        let products = [
            { id: 1, title: "무선 이어폰 X1", cat: 1, price: 159000, sale_price: 129000, img: "https://picsum.photos/seed/ear/600/600", slug: "wireless-earbuds-x1", soldout: false, created_at: daysAgo(3) },
            { id: 2, title: "키보드 K87 (청축)", cat: 1, price: 99000, sale_price: 79000, img: "https://picsum.photos/seed/key/600/600", slug: "keyboard-k87", soldout: false, created_at: daysAgo(30) },
            { id: 3, title: "스마트 램프", cat: 1, price: 59000, sale_price: 39000, img: "https://picsum.photos/seed/lamp/600/600", slug: "smart-lamp", soldout: true, created_at: daysAgo(10) },
            { id: 4, title: "코지 머그컵", cat: 4, price: 12000, sale_price: 9900, img: "https://picsum.photos/seed/mug/600/600", slug: "cozy-mug", soldout: false, created_at: daysAgo(1) },
            ...Array.from({ length: 40 }).map((_, i) => ({
                id: 5 + i,
                title: `샘플 상품 ${i + 1}`,
                cat: (i % 4) + 1,
                price: 30000 + i * 300,
                sale_price: i % 3 === 0 ? 26000 + i * 200 : 0,
                img: "https://picsum.photos/seed/p" + (i + 100) + "/600/600",
                slug: "sample-" + (i + 1),
                soldout: i % 7 === 0,
                created_at: daysAgo(2 + (i % 50))
            }))
        ];

        let filteredList = [];
        let page = 1, pageSize = 12;

        const qs = (s, el = document) => el.querySelector(s);
        const qsa = (s, el = document) => Array.from(el.querySelectorAll(s));
        const elGrid = () => qs("#grid");
        const fmtKRW = n => (n ?? 0).toLocaleString("ko-KR") + "원";
        const isNew = d => {
            const created = new Date(d).getTime();
            return Date.now() - created < 14 * 24 * 60 * 60 * 1000;
        };
        function discountRate(p, s) {
            return p && s && s < p ? Math.round((1 - s / p) * 100) : 0;
        }

        (function () {
            const sel = qs("#fCategory");
            sel.innerHTML = '<option value="">카테고리 전체</option>' + categories.map(c => `<option value="${c.id}">${c.name}</option>`).join("");
        })();

        function renderGridPage() {
            const grid = elGrid();
            grid.innerHTML = "";

            const total = filteredList.length;
            const totalPages = Math.max(1, Math.ceil(total / pageSize));
            if (page > totalPages) page = totalPages;

            const startIdx = (page - 1) * pageSize;
            const endIdx = Math.min(startIdx + pageSize, total);
            const slice = filteredList.slice(startIdx, endIdx);

            qs("#rangeInfo").textContent = total ? `총 ${total.toLocaleString()}개 중 ${startIdx + 1}–${endIdx} 표시` : "총 0개";

            slice.forEach(p => {
                const catName = (categories.find(c => c.id === p.cat) || {}).name || "";
                const rate = discountRate(p.price, p.sale_price);
                const priceHtml = p.sale_price && p.sale_price < p.price
                    ? `<div class="p-price"><div class="sale">${fmtKRW(p.sale_price)}</div><div class="origin">${fmtKRW(p.price)}</div></div>`
                    : `<div class="p-price"><div class="sale">${fmtKRW(p.price)}</div></div>`;

                const card = document.createElement("a");
                card.href = `02_01_01.html?val=${p.slug}`;
                card.className = "product";
                card.innerHTML =
                    `<div class="thumb-wrap"><img src="${p.img}" alt="${p.title}"><div class="badges">${p.soldout ? '<span class="badge soldout">품절</span>' : ""}${rate ? `<span class="badge sale">-${rate}%</span>` : ""}${isNew(p.created_at) ? '<span class="badge new">NEW</span>' : ""}</div></div>` +
                    `<div class="p-body"><div class="p-title">${p.title}</div><div class="p-cat">${catName}</div>${priceHtml}<div class="p-actions"><button class="btn small primary" type="button" data-buy="${p.id}" ${p.soldout ? "disabled" : ""}>바로구매</button><button class="btn small" type="button" data-cart="${p.id}" ${p.soldout ? "disabled" : ""}>장바구니</button></div></div>`;

                grid.appendChild(card);
            });

            renderPager(total, startIdx, endIdx, totalPages);
            bindCardActions();
        }

        function renderPager(total, startIdx, endIdx, totalPages) {
            const cont = qs("#pager");
            cont.innerHTML = "";

            const prev = document.createElement("button");
            prev.className = "page-btn";
            prev.textContent = "‹";
            prev.title = "이전 페이지";
            prev.disabled = page <= 1;
            prev.addEventListener("click", () => setPage(page - 1));
            cont.appendChild(prev);

            const maxShow = 7;
            let start = Math.max(1, page - Math.floor(maxShow / 2));
            let end = Math.min(totalPages, start + maxShow - 1);
            if (end - start + 1 < maxShow) start = Math.max(1, end - maxShow + 1);

            for (let p = start; p <= end; p++) {
                const b = document.createElement("button");
                b.className = "page-btn" + (p === page ? " active" : "");
                b.textContent = p;
                b.setAttribute("aria-label", `페이지 ${p}`);
                b.addEventListener("click", () => setPage(p));
                cont.appendChild(b);
            }

            const next = document.createElement("button");
            next.className = "page-btn";
            next.textContent = "›";
            next.title = "다음 페이지";
            next.disabled = page >= totalPages;
            next.addEventListener("click", () => setPage(page + 1));
            cont.appendChild(next);
        }

        function setPage(p) {
            page = Math.max(1, p);
            renderGridPage();
            const top = qs(".card").getBoundingClientRect().top + window.scrollY - 10;
            window.scrollTo({ top, behavior: "smooth" });
        }

        function buildFilteredList() {
            const q = qs("#q").value.trim().toLowerCase();
            const cat = qs("#fCategory").value ? Number(qs("#fCategory").value) : "";
            const sort = qs("#fSort").value;

            let list = products.slice();

            if (q) {
                list = list.filter(p =>
                    (p.title || "").toLowerCase().includes(q) ||
                    (p.slug || "").toLowerCase().includes(q)
                );
            }
            if (cat !== "") {
                list = list.filter(p => p.cat === cat);
            }

            list.sort((a, b) => {
                if (sort === "low") return (a.sale_price || a.price) - (b.sale_price || b.price);
                if (sort === "high") return (b.sale_price || b.price) - (a.sale_price || a.price);
                if (sort === "latest") return new Date(b.created_at) - new Date(a.created_at);
                if (sort === "sale") {
                    const ra = discountRate(a.price, a.sale_price);
                    const rb = discountRate(b.price, b.sale_price);
                    if (ra !== rb) return rb - ra;
                }
                const pa = (a.soldout ? 1 : 0) - (b.soldout ? 1 : 0);
                if (pa !== 0) return pa;
                const sa = discountRate(b.price, b.sale_price) - discountRate(a.price, a.sale_price);
                if (sa !== 0) return sa;
                return new Date(b.created_at) - new Date(a.created_at);
            });

            filteredList = list;
        }

        function applyAndRender(reset = false) {
            buildFilteredList();
            if (reset) page = 1;
            renderGridPage();
        }

        function bindCardActions() {
            qsa("button[data-buy]").forEach(b => {
                b.addEventListener("click", e => {
                    e.preventDefault();
                    const id = Number(b.dataset.buy);
                    const p = products.find(x => x.id === id);
                    if (!p || p.soldout) {
                        alert("구매할 수 없는 상품입니다.");
                        return;
                    }
                    alert(`바로구매: ${p.title}\n(데모: /checkout 으로 이동하거나 바로 결제 진입)`);
                });
            });
            qsa("button[data-cart]").forEach(b => {
                b.addEventListener("click", e => {
                    e.preventDefault();
                    const id = Number(b.dataset.cart);
                    const p = products.find(x => x.id === id);
                    if (!p || p.soldout) {
                        alert("장바구니 담을 수 없는 상품입니다.");
                        return;
                    }
                    alert(`장바구니 담기: ${p.title}\n(데모: API 호출 후 미니카트 표시)`);
                });
            });
        }

        qs("#btnSearch").addEventListener("click", () => applyAndRender(true));
        qs("#btnReset").addEventListener("click", () => {
            qs("#q").value = "";
            qs("#fCategory").value = "";
            qs("#fSort").value = "best";
            applyAndRender(true);
        });

        let typingTimer;
        qs("#q").addEventListener("input", () => {
            clearTimeout(typingTimer);
            typingTimer = setTimeout(() => applyAndRender(true), 250);
        });
        qs("#fCategory").addEventListener("change", () => applyAndRender(true));
        qs("#fSort").addEventListener("change", () => applyAndRender(true));
        qs("#selPageSize").addEventListener("change", e => {
            pageSize = Number(e.target.value) || 12;
            page = 1;
            renderGridPage();
        });

        applyAndRender(true);
        pageSize = Number(qs("#selPageSize").value) || 12;
        renderGridPage();
    </script>
</body>
</html>
