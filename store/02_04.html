<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>쿠폰</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="css/navbar.css?v=val_251015_001">
    <link rel="stylesheet" href="test/test.css?v=val_251015_001">
    <link rel="stylesheet" href="css/member_store.css?v=val_251015_001">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
    <style>
        .btn{display:inline-flex;align-items:center;gap:6px;white-space:nowrap}
        .btn[disabled]{opacity:.5;cursor:not-allowed}
        .layout{display:grid;grid-template-columns:1fr 360px;gap:16px;align-items:start}
        @media (max-width:1000px){.layout{grid-template-columns:1fr}}
        .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
        .seg{display:flex;gap:6px;flex-wrap:wrap}
        .seg .btn{border-radius:999px;padding:8px 12px}
        .grow{flex:1}
        .addcoupon{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
        .cp-list{display:grid;gap:12px}
        .coupon{display:grid;grid-template-columns:96px 1fr auto;gap:12px;align-items:center;border:1px solid var(--cb-line);border-radius:14px;padding:12px;background:#fff}
        .cp-badge{width:96px;height:96px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:900;background:#eef3ff;color:#2b63f1;border:1px dashed #dbe6ff}
        .cp-body{display:flex;flex-direction:column;gap:6px}
        .cp-title{font-weight:900;font-size:16px}
        .cp-meta{color:var(--cb-sub);font-size:12px}
        .cp-exp{font-size:12px}
        .cp-actions{display:flex;gap:8px;align-items:center;justify-content:flex-end;flex-wrap:wrap}
        .badge.ok{background:#e9f7ef;color:#1e7e34;border:1px solid #d6f0de}
        .badge.warn{background:#fff6d8;color:#8a6d00;border:1px solid #ffecb3}
        .badge.danger{background:#ffecec;color:#b02a37;border:1px solid #ffd6d6}
        .coupon.used,.coupon.expired{opacity:.6}
        @media (max-width:560px){.coupon{grid-template-columns:1fr;align-items:stretch}.cp-badge{width:100%;height:72px}.cp-actions{justify-content:flex-start}}
        .sum-line{display:flex;justify-content:space-between;align-items:center;margin:8px 0;font-size:15px}
        .sum-total{display:flex;justify-content:space-between;align-items:center;margin-top:10px;padding-top:10px;border-top:1px dashed var(--cb-line);font-size:18px;font-weight:900}
        .buybar{display:none}
        @media (max-width:900px){.buybar{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid var(--cb-line);box-shadow:0 -6px 16px rgba(51,65,85,.06);display:flex;gap:10px;padding:10px 12px;align-items:center;z-index:50}.buybar .price{font-weight:900;font-size:16px;margin-right:auto}body{padding-bottom:80px}}
    </style>
</head>
<body>
<aside class="cb-sidemenu"><!--개발시 해당 메뉴는 기존 메뉴를 사용하세요 {% include 'admin/navbar.html' %} -->
    <div class="cb-sidemenu-inner cb-menu-style">
        <div class="cb-menu-admin-logo" style="text-align:center;margin-bottom:12px;"><img src="test/testai.png" alt="사이트 로고" style="max-width:150px;object-fit:contain;"></div>
        <div class="cb-menu-admin-name">테스트 유저님<br></div>
        <a><span class="cb-menu-icon"><i class="fa-solid fa-arrow-right-from-bracket"></i></span>로그아웃</a>
        <div class="cb-menu-toggle-all" style="display:flex;gap:15px;justify-content:flex-end;padding:12px;">
            <a type="button" onclick="expandAllMenus()" class="toggle_all" id="expandAllBtn_p">＋</a>
            <a type="button" onclick="collapseAllMenus()" class="toggle_all" id="collapseAllBtn_p">－</a>
        </div>
        <div class="cb-menu-group" data-key="menu_general">
            <div class="cb-menu-group-title" onclick="toggleMenuGroup(this)">스토어</div>
            <div class="cb-menu-group-body">
                <a href="02_01.html" class="cb-sidemenu-link"><span class="cb-menu-icon"><i class="fa-solid fa-cart-shopping"></i></span>쇼핑</a>
                <a href="02_02.html" class="cb-sidemenu-link"><span class="cb-menu-icon"><i class="fa-solid fa-basket-shopping"></i></span>장바구니</a>
                <a href="02_03.html" class="cb-sidemenu-link"><span class="cb-menu-icon"><i class="fa-solid fa-file-invoice-dollar"></i></span>주문/결제 내역</a>
                <a href="02_04.html" class="cb-sidemenu-link"><span class="cb-menu-icon"><i class="fa-solid fa-ticket"></i></span>쿠폰</a>
            </div>
        </div>
        <a>&nbsp;</a>
    </div>
</aside>
<div class="wrap">
    <div class="title">쿠폰</div>
    <div class="sub">쿠폰을 등록하고 사용 가능 여부를 확인해 보세요. 정률 쿠폰은 최대 할인 한도가 적용될 수 있어요.</div>
    <div class="layout">
        <div class="card">
            <div class="toolbar">
                <div class="seg">
                    <button class="btn small" data-filter="all"><i class="fa-solid fa-list"></i> 전체</button>
                    <button class="btn small" data-filter="usable"><i class="fa-solid fa-check"></i> 사용 가능</button>
                    <button class="btn small" data-filter="used"><i class="fa-regular fa-circle-check"></i> 사용됨</button>
                    <button class="btn small" data-filter="expired"><i class="fa-regular fa-clock"></i> 만료</button>
                </div>
                <div class="grow"></div>
                <div class="addcoupon">
                    <input type="text" id="cpCode" class="box" placeholder="쿠폰 코드 입력">
                    <button class="btn small" id="btnAdd"><i class="fa-solid fa-ticket"></i> 등록</button>
                </div>
            </div>
            <div style="height:10px"></div>
            <div class="cp-list" id="cpList"></div>
        </div>
        <div class="card" id="summary">
            <div style="font-weight:900;margin-bottom:6px">적용 미리보기</div>
            <div class="hint">장바구니 예상 금액을 입력하고 쿠폰을 선택하면 할인/결제 금액이 계산됩니다. (데모)</div>
            <div style="height:8px"></div>
            <div class="sum-line"><span>장바구니 금액</span><span><input type="number" id="inputSubtotal" class="box" style="width:140px;text-align:right" value="50000"></span></div>
            <div class="sum-line"><span>선택 쿠폰</span><span id="selName" class="hint">없음</span></div>
            <div class="sum-line"><span>할인 금액</span><span id="selDiscount">0원</span></div>
            <div class="sum-total"><span>예상 결제금액</span><span id="selTotal">50,000원</span></div>
            <button class="btn primary" style="width:100%;margin-top:12px" id="btnApply"><i class="fa-solid fa-check"></i> 쿠폰 적용(데모)</button>
        </div>
    </div>
</div>
<div class="buybar" id="buybar">
    <div class="price" id="barPrice">50,000원</div>
    <button class="btn primary" id="barApply"><i class="fa-solid fa-check"></i> 적용</button>
</div>
<script>
    const fmtKRW = n => (n ?? 0).toLocaleString('ko-KR') + '원';
    const todayStr = () => new Date().toISOString().slice(0, 10);
    const toDate = d => new Date(d + 'T00:00:00');

    let coupons = [
        { id: 'C3000', name: '3,000원 할인', type: 'amount', amount: 3000, minSpend: 10000, state: 'usable', from: '2025-09-01', to: '2025-12-31', desc: '1만원 이상 주문 시' },
        { id: 'P10', name: '10% 할인(최대 10,000원)', type: 'percent', rate: 10, cap: 10000, minSpend: 0, state: 'usable', from: '2025-09-01', to: '2025-12-31', desc: '상한 1만원' },
        { id: 'FREESHIP', name: '배송비 3,000원 쿠폰', type: 'amount', amount: 3000, minSpend: 0, state: 'used', from: '2025-08-01', to: '2025-09-30', desc: '과거 사용됨' },
        { id: 'OLD5', name: '5,000원 할인', type: 'amount', amount: 5000, minSpend: 20000, state: 'expired', from: '2025-06-01', to: '2025-07-31', desc: '기간 만료' }
    ];

    const elList = document.getElementById('cpList');
    const elSubtotal = document.getElementById('inputSubtotal');
    const elSelName = document.getElementById('selName');
    const elSelDiscount = document.getElementById('selDiscount');
    const elSelTotal = document.getElementById('selTotal');
    const elBarPrice = document.getElementById('barPrice');

    let currentFilter = 'all';
    let selectedId = '';

    function checkExpired(cp) { return toDate(cp.to) < toDate(todayStr()); }

    function calcDiscount(cp, subtotal) {
        if (!cp) return 0;
        if (checkExpired(cp) || cp.state !== 'usable') return 0;
        if (subtotal < (cp.minSpend || 0)) return 0;
        if (cp.type === 'amount') return Math.min(cp.amount || 0, subtotal);
        if (cp.type === 'percent') {
            const raw = Math.floor(subtotal * (cp.rate || 0) / 100);
            const capped = Math.min(raw, cp.cap || Infinity);
            return Math.min(capped, subtotal);
        }
        return 0;
    }

    function render() {
        if (selectedId && !coupons.find(c => c.id === selectedId)) selectedId = '';
        elList.innerHTML = '';
        const now = todayStr();
        coupons.forEach(cp => {
            const expired = toDate(cp.to) < toDate(now);
            const usable = (cp.state === 'usable' && !expired);
            const hidden =
                (currentFilter === 'usable' && !usable) ||
                (currentFilter === 'used' && cp.state !== 'used') ||
                (currentFilter === 'expired' && !expired);
            if (hidden) return;

            const row = document.createElement('div');
            row.className = 'coupon' + (cp.state === 'used' ? ' used' : '') + (expired ? ' expired' : '');
            const badgeText = cp.type === 'amount' ? ((cp.amount || 0).toLocaleString('ko-KR') + '원') : ((cp.rate || 0) + '%');
            const stateBadge = expired ? '<span class="badge danger">만료</span>' :
                               (cp.state === 'used' ? '<span class="badge warn">사용됨</span>' :
                               '<span class="badge ok">사용 가능</span>');
            row.innerHTML =
                `<div class="cp-badge">${badgeText}</div>` +
                `<div class="cp-body"><div class="cp-title">${cp.name}</div><div class="cp-meta">최소주문 ${fmtKRW(cp.minSpend || 0)} · 유효기간 ${cp.from} ~ ${cp.to}</div><div class="cp-exp hint">${cp.desc || ''}</div><div>${stateBadge}</div></div>` +
                `<div class="cp-actions"><button class="btn small" data-act="select" data-id="${cp.id}" ${usable ? '' : 'disabled'}><i class="fa-solid fa-check"></i> 선택</button><button class="btn small ghost" data-act="detail" data-id="${cp.id}"><i class="fa-regular fa-circle-question"></i> 상세</button></div>`;
            elList.appendChild(row);
        });
        updatePreview();
    }

    function updatePreview() {
        const subtotal = parseInt(elSubtotal.value || '0', 10);
        const cp = coupons.find(c => c.id === selectedId);
        const discount = calcDiscount(cp, subtotal);
        elSelName.textContent = cp ? cp.name : '없음';
        elSelDiscount.textContent = fmtKRW(discount);
        elSelTotal.textContent = fmtKRW(Math.max(0, subtotal - discount));
        elBarPrice.textContent = elSelTotal.textContent;
    }

    document.querySelectorAll('[data-filter]').forEach(b => { b.onclick = () => { currentFilter = b.dataset.filter; render(); }; });
    document.getElementById('btnAdd').onclick = () => {
        const code = (document.getElementById('cpCode').value || '').trim().toUpperCase();
        if (!code) { alert('쿠폰 코드를 입력해 주세요.'); return; }
        if (code === 'NEW10') {
            coupons.unshift({ id: 'NEW10', name: '신규 10% 할인(최대 5,000원)', type: 'percent', rate: 10, cap: 5000, minSpend: 0, state: 'usable', from: todayStr(), to: '2025-12-31', desc: '신규 발급' });
            alert('쿠폰이 등록되었습니다.');
            document.getElementById('cpCode').value = '';
            currentFilter = 'all';
            render();
        } else {
            alert('유효하지 않은 코드입니다. (데모)');
        }
    };
    document.getElementById('cpList').addEventListener('click', e => {
        const btn = e.target.closest('button[data-act]');
        if (!btn) return;
        const act = btn.dataset.act;
        const id = btn.dataset.id;
        if (act === 'select') { selectedId = id; updatePreview(); }
        if (act === 'detail') {
            const cp = coupons.find(c => c.id === id);
            if (!cp) return;
            alert(`쿠폰 정보\n- 이름: ${cp.name}\n- 유형: ${cp.type === 'amount' ? '정액' : '정률'}\n- 조건: 최소 ${fmtKRW(cp.minSpend || 0)}\n- 기간: ${cp.from} ~ ${cp.to}`);
        }
    });
    document.getElementById('inputSubtotal').oninput = updatePreview;
    document.getElementById('btnApply').onclick = () => applyCoupon();
    document.getElementById('barApply').onclick = () => applyCoupon();

    function applyCoupon() {
        const cp = coupons.find(c => c.id === selectedId);
        if (!cp) { alert('적용할 쿠폰을 선택해 주세요.'); return; }
        const subtotal = parseInt(elSubtotal.value || '0', 10);
        const discount = calcDiscount(cp, subtotal);
        if (discount <= 0) { alert('조건을 만족하지 않아 적용할 수 없습니다.'); return; }
        alert(`쿠폰 적용 완료 (데모)\n- ${cp.name}\n- 할인: ${fmtKRW(discount)}\n- 결제예정: ${fmtKRW(subtotal - discount)}`);
    }

    render();
</script>
</body>
</html>
